name: Release (Pluxel template)

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout chatbots repo
        uses: actions/checkout@v4

      - name: Setup toolchain
        uses: PluxelJS/pluxel-template/.github/actions/setup-pluxel@main
        with:
          node-version: 'lts/*'
          pnpm-version: 'latest'
          bun-version: '1.3.3'

      - name: Debug npm OIDC
        run: |
          npm -v
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL:+present}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+present}"
          echo "NODE_AUTH_TOKEN=${NODE_AUTH_TOKEN:+present}"

      - name: Publish via template action
        uses: PluxelJS/pluxel-template/.github/actions/release-plugins@main
        with:
          package-roots: .
          # Don't use --frozen-lockfile because:
          # 1. Chatbots repo may not have pnpm-lock.yaml
          # 2. The runtime is hydrated from pluxel-template with its own dependencies
          # 3. Install happens in .pluxel/runtime with dynamically merged package.json
          pnpm-install-args: --prefer-offline

      - name: Dump latest npm debug log on failure
        run: |
          set -euo pipefail
      
          LOG_DIR="$HOME/.npm/_logs"
      
          echo "Looking for debug logs in $LOG_DIR"
          ls -ltr "$LOG_DIR" || echo "no log dir"
      
          LAST_LOG="$(ls -t "$LOG_DIR"/*-debug-*.log 2>/dev/null | head -n 1 || true)"
      
          if [ -n "$LAST_LOG" ]; then
            echo "===== BEGIN npm debug log: $LAST_LOG ====="
            cat "$LAST_LOG"
            echo "===== END npm debug log ====="
      
            echo
            echo "===== OIDC-related lines (grep oidc / exchange / token) ====="
            grep -Ei 'oidc|exchange|token' "$LAST_LOG" || echo "no oidc-related lines found"
            echo "============================================================="
          else
            echo "No npm debug log found under $LOG_DIR"
          fi
        shell: bash